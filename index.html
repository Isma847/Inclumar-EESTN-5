<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lugares Accesibles - IncluMar</title>
    <link
      rel="stylesheet"
      href="https://necolas.github.io/normalize.css/8.0.1/normalize.css"
    />
    <link rel="stylesheet" href="./css/PagPrincipal.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <header>
      <div>
        <a href="./index.html"><h1>IncluMar</h1></a>
        <input type="text" id="search-input" placeholder="Buscar lugares..." />
      </div>
      <div class="usuario-container">
        <span class="usuario-nombre" style="color: white; margin-right: 10px"
          >Cargando...</span
        >
        <img
          src="./Imagenes/usuario.png"
          alt="Usuario"
          class="usuario"
          onclick="mostrarMenuUsuario()"
        />

        <div id="menu-usuario" class="menu-usuario hidden">
          <p class="usuario-email"></p>
          <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </div>
      </div>
    </header>

    <main>
      <section id="mapa"></section>

      <section class="places-list">
        <div id="places-head">
          <h2>Lugares Accesibles</h2>
          <button id="Filtros" onclick="abrirModal('filtrado')">Filtros</button>
        </div>
        <div id="places-div"></div>

        <template id="place-template">
          <div class="place-card">
            <div class="place-flex">
              <div class="place-info">
                <h3></h3>
                <p class="category"></p>
                <p class="address"></p>
              </div>
              <div class="btn-container"><button>Ver m√°s</button></div>
            </div>
            <div class="tags-container"></div>
          </div>
        </template>

        <div id="detalle-establecimiento" class="establecimiento hidden">
          <div class="establecimiento-top">
            <div class="establecimiento-flex">
              <div>
                <h2 id="detalle-nombre"></h2>
                <p id="detalle-tipo"></p>
                <p id="detalle-ubicacion"></p>
              </div>
              <div id="calificacion">
                <img src="./Imagenes/estrella_vacia.png" alt="" />
                <img src="./Imagenes/estrella_vacia.png" alt="" />
                <img src="./Imagenes/estrella_vacia.png" alt="" />
                <img src="./Imagenes/estrella_vacia.png" alt="" />
                <img src="./Imagenes/estrella_vacia.png" alt="" />
              </div>
            </div>
            <div id="detalle-etiquetas" class="establecimiento-etiquetas"></div>
          </div>
          <div class="establecimiento-btn">
            <button>Ver en el mapa</button>
            <button>Contacto</button>
          </div>

          <h2>Rese√±as de usuarios</h2>
          <div id="detalle-comentarios" class="comentarios-container">
            <template id="comentario-template">
              <div class="comentario">
                <div class="comentario-usuario">
                  <img
                    src="./Imagenes/usuario.png"
                    alt=""
                    class="pfp-usuario"
                  />
                  <div class="nombre-usuario"></div>
                </div>
                <div class="comentario-info">
                  <div class="estrellas"></div>
                  <div class="fecha"></div>
                </div>
                <p class="texto-comentario"></p>
                <div class="comentario-acciones">
                  <button class="btn-like">
                    <span class="like-icon">üëç</span>
                    <span class="like-count">0</span>
                  </button>
                </div>
              </div>
            </template>

            <p style="padding: 0 1.5rem" id="sin-comentarios">
              A√∫n no hay rese√±as para este lugar.
            </p>
          </div>
          <button onclick="abrirModal('comentar')" style="margin-left: 1.5rem">
            Escribir rese√±a
          </button>
        </div>
      </section>
    </main>

    <dialog id="comentar">
      <div class="modal-header">
        <h2>Escribir rese√±a</h2>
        <button onclick="cerrarModal('comentar')">√ó</button>
      </div>
      <div class="modal-content">
        <h3 id="modal-establecimiento-nombre">ESTABLECIMIENTO</h3>
        <p>Califica tu experiencia:</p>
        <div class="estrellas" id="estrellas-calificacion">
          <img src="./Imagenes/estrella_vacia.png" alt="" data-value="1" />
          <img src="./Imagenes/estrella_vacia.png" alt="" data-value="2" />
          <img src="./Imagenes/estrella_vacia.png" alt="" data-value="3" />
          <img src="./Imagenes/estrella_vacia.png" alt="" data-value="4" />
          <img src="./Imagenes/estrella_vacia.png" alt="" data-value="5" />
        </div>
        <textarea
          id="comentario-texto"
          placeholder="Comparte tu experiencia en este lugar..."
        ></textarea>
        <button onclick="enviarComentario()">Enviar rese√±a</button>
      </div>
    </dialog>

    <dialog id="filtrado">
      <div class="modal-header">
        <h2>Filtros de b√∫squeda</h2>
        <button onclick="cerrarModal('filtrado')">√ó</button>
      </div>
      <div class="modal-content">
        <form id="form-filtros">
          <label>
            <input type="checkbox" value="Rampas" /> Rampas de acceso
          </label>
          <label>
            <input type="checkbox" value="Personal capacitado" /> Personal
            capacitado
          </label>
          <label>
            <input type="checkbox" value="Men√∫ Braile" /> Men√∫ en braile
          </label>
          <label>
            <input type="checkbox" value="Ba√±os adaptados" /> Ba√±os adaptados
          </label>
          <label>
            <input type="checkbox" value="Estacionamiento reservado" />
            Estacionamiento reservado
          </label>
        </form>
        <div class="modal-actions">
          <button onclick="aplicarFiltros()">Aplicar filtros</button>
          <button onclick="limpiarFiltros()" class="btn-secondary">
            Limpiar
          </button>
        </div>
      </div>
    </dialog>

    <footer></footer>

    <script src="./js/authGuard.js"></script>
    <script src="./js/mapa.js"></script>
    <script src="./js/Establecimientos.js"></script>

    <script>
      console.log("üöÄ Cargando script principal del index...");

      function abrirModal(modal) {
        console.log("Abriendo modal:", modal);
        const m = document.getElementById(modal);
        if (!m) {
          console.error("Modal no encontrado:", modal);
          return;
        }

        if (modal === "comentar" && window.establecimientoActual) {
          const nombreElement = document.getElementById(
            "modal-establecimiento-nombre"
          );
          if (nombreElement) {
            nombreElement.textContent =
              window.establecimientoActual.nombre || "ESTABLECIMIENTO";
          }
        }

        try {
          m.showModal();
          console.log("‚úÖ Modal abierto:", modal);
        } catch (error) {
          console.error("Error al abrir modal:", error);
        }
      }

      function cerrarModal(modal) {
        console.log("Cerrando modal:", modal);
        const m = document.getElementById(modal);
        if (!m) {
          console.error("Modal no encontrado:", modal);
          return;
        }

        try {
          m.close();

          if (modal === "comentar") {
            const textArea = document.getElementById("comentario-texto");
            if (textArea) textArea.value = "";

            if (typeof window.calificacionSeleccionada !== "undefined") {
              window.calificacionSeleccionada = 0;
            }

            if (typeof window.actualizarEstrellas === "function") {
              window.actualizarEstrellas();
            }
          }

          console.log("‚úÖ Modal cerrado:", modal);
        } catch (error) {
          console.error("Error al cerrar modal:", error);
        }
      }

      function configurarEstrellasModal() {
        const estrellas = document.querySelectorAll(
          "#estrellas-calificacion img"
        );

        estrellas.forEach((estrella, index) => {
          estrella.addEventListener("click", () => {
            window.calificacionSeleccionada = index + 1;
            mostrarEstrellasModal(window.calificacionSeleccionada);
            console.log(
              "Calificaci√≥n seleccionada:",
              window.calificacionSeleccionada
            );
          });

          estrella.addEventListener("mouseover", () => {
            mostrarEstrellasModal(index + 1);
          });
        });

        const contenedor = document.getElementById("estrellas-calificacion");
        if (contenedor) {
          contenedor.addEventListener("mouseleave", () => {
            mostrarEstrellasModal(window.calificacionSeleccionada || 0);
          });
        }
      }

      function mostrarEstrellasModal(cantidad) {
        const estrellas = document.querySelectorAll(
          "#estrellas-calificacion img"
        );
        estrellas.forEach((estrella, index) => {
          estrella.src =
            index < cantidad
              ? "./Imagenes/estrella_llena.png"
              : "./Imagenes/estrella_vacia.png";
        });
      }

      function mostrarMenuUsuario() {
        console.log("mostrarMenuUsuario llamada");
        const menu = document.getElementById("menu-usuario");
        if (menu) {
          menu.classList.toggle("hidden");
          console.log(
            "Menu toggled, hidden:",
            menu.classList.contains("hidden")
          );
        } else {
          console.error("Elemento menu-usuario no encontrado");
        }
      }

      document.addEventListener("click", function (event) {
        const menu = document.getElementById("menu-usuario");
        const usuarioImg = document.querySelector(".usuario");
        if (usuarioImg && menu && !usuarioImg.contains(event.target)) {
          menu.classList.add("hidden");
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        console.log("üöÄ Inicializando script principal...");

        setTimeout(() => {
          configurarEstrellasModal();
          console.log("‚úÖ Estrellas del modal configuradas");
        }, 500);

        console.log("Verificando elementos:");
        console.log(
          "- menu-usuario:",
          !!document.getElementById("menu-usuario")
        );
        console.log("- places-div:", !!document.getElementById("places-div"));
        console.log("- mapa:", !!document.getElementById("mapa"));
        console.log(
          "- search-input:",
          !!document.getElementById("search-input")
        );
        console.log("- modal comentar:", !!document.getElementById("comentar"));
        console.log("- modal filtrado:", !!document.getElementById("filtrado"));
      });

      window.abrirModal = abrirModal;
      window.cerrarModal = cerrarModal;
      window.mostrarMenuUsuario = mostrarMenuUsuario;
      window.configurarEstrellasModal = configurarEstrellasModal;
      window.mostrarEstrellasModal = mostrarEstrellasModal;

      console.log("‚úÖ Script principal del index cargado correctamente");
    </script>
  </body>
</html>
